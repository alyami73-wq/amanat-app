 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ุจุฑูุงูุฌ ุงูุงุนุงุดุฉ</title>

  <!-- ููู ูู PWA -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">

  <!-- ุฅุนุฏุงุฏ ูู Web App ุนูู ุงูุขูููู -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ุจุฑูุงูุฌ ุงูุฅุนุงูุฉ">

  <!-- ุฃููููุฉ ุงูุชุทุจูู ููุขูููู (ุญุทู ุงูุตูุฑุฉ ูู ูุฌูุฏ icons) -->
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- ููู ุงูู manifest ุงูุฎุงุต ุจุงูู PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- ููู ุงูุณุชุงูู -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="app">

    <header class="top">
      <h1>ูุธุงู ุงูุงุนุงุดุฉ</h1>

      <!-- ุฃุฒุฑุงุฑ ุงูุชููู ุจูู ุงูุตูุญุงุช -->
      <nav class="nav">
        <button onclick="showPage('mainPage')">1- ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</button>
        <button onclick="showPage('mealsPage')">2- ุตูุญุฉ ุงููุฌุจุงุช</button>
        <button onclick="showPage('prepPage')">3- ุตูุญุฉ ุงูุฅุนุฏุงุฏ</button>
        <button onclick="showPage('calcPage')">4- ุตูุญุฉ ุงูุญุณุงุจุงุช</button>
        <button onclick="showPage('reportPage')">5- ููุฎุต ุงููุฌุจุงุช</button>
        <button onclick="showPage('monthsPage'); renderMonthsPage();">6- ุงูุฃุดูุฑ ุงููุญููุธุฉ</button>
      </nav>

      <!-- ุดุฑูุท ุญูุธ ุงูุฃุดูุฑ + ุงููุจูุบ ุงููุชุจูู ุงูููู -->
      <div class="saved-bar">
        <button class="secondary-btn small" id="saveMonthBtn">๐พ ุญูุธ ุจูุงูุงุช ูุฐุง ุงูุดูุฑ</button>

        <select id="savedMonthsSelect">
          <option value="">ูุง ุชูุฌุฏ ุฃุดูุฑ ูุญููุธุฉ ุจุนุฏ</option>
        </select>

        <button class="secondary-btn small" id="loadMonthBtn">ุงุณุชุฑุฌุงุน ุงูุดูุฑ ุงููุญุฏุฏ</button>
        <button class="secondary-btn small" id="updateMonthBtn">โ ุชุนุฏูู ุงูุดูุฑ ุงููุญุฏุฏ</button>
        <button class="secondary-btn small danger" id="deleteMonthBtn">๐ ุญุฐู ุงูุดูุฑ ุงููุญุฏุฏ</button>

        <span class="remaining-box">
          ุฅุฌูุงูู ุงููุจูุบ ุงููุชุจูู ููุฃุดูุฑ ุงููุญููุธุฉ:
          <span id="globalRemaining">0.00</span> ุฑ.ุณ
        </span>
      </div>
    </header>

    <!-- 1- ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ -->
    <section id="mainPage" class="page">
      <h2>1- ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</h2>
      <div class="card">
        <div class="form-row">
          <label for="monthSelect">ุงูุดูุฑ ุงููููุงุฏู (ูููู ููู ุฌููุน ุงูุฃุดูุฑ)</label>
          <select id="monthSelect">
            <option value="">-- ุงุฎุชุฑ ุงูุดูุฑ --</option>
            <option value="ููุงูุฑ">ููุงูุฑ</option>
            <option value="ูุจุฑุงูุฑ">ูุจุฑุงูุฑ</option>
            <option value="ูุงุฑุณ">ูุงุฑุณ</option>
            <option value="ุฃุจุฑูู">ุฃุจุฑูู</option>
            <option value="ูุงูู">ูุงูู</option>
            <option value="ููููู">ููููู</option>
            <option value="ููููู">ููููู</option>
            <option value="ุฃุบุณุทุณ">ุฃุบุณุทุณ</option>
            <option value="ุณุจุชูุจุฑ">ุณุจุชูุจุฑ</option>
            <option value="ุฃูุชูุจุฑ">ุฃูุชูุจุฑ</option>
            <option value="ููููุจุฑ">ููููุจุฑ</option>
            <option value="ุฏูุณูุจุฑ">ุฏูุณูุจุฑ</option>
          </select>
        </div>

        <div class="form-row">
          <label for="availableAmount">ุงููุจูุบ ุงููุชููุฑ (ุฑ.ุณ)</label>
          <input type="number" id="availableAmount" min="0" step="0.01">
        </div>

        <div class="form-row two-cols">
          <div>
            <label for="dateFrom">ุงูุชุงุฑูุฎ ูู</label>
            <input type="date" id="dateFrom">
          </div>
          <div>
            <label for="dateTo">ุงูุชุงุฑูุฎ ุฅูู</label>
            <input type="date" id="dateTo">
          </div>
        </div>

        <button id="saveMainBtn" class="primary-btn">ุญูุธ ุจูุงูุงุช ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</button>
      </div>
    </section>

    <!-- 2- ุตูุญุฉ ุงููุฌุจุงุช -->
    <section id="mealsPage" class="page hidden">
      <h2>2- ุตูุญุฉ ุงููุฌุจุงุช</h2>
      <button class="secondary-btn back-btn" onclick="showPage('mainPage')">โฌ ุฑุฌูุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ</button>

      <div class="card">
        <div class="form-row three-cols">
          <div>
            <label for="mealDate">ุงูุชุงุฑูุฎ ุจุงููููุงุฏู</label>
            <input type="date" id="mealDate">
          </div>
          <div>
            <label for="mealCount">ุนุฏุฏ ุงููุฌุจุงุช</label>
            <input type="number" id="mealCount" min="0">
          </div>
          <div>
            <label for="mealCost">ุชูููุฉ ุงููุฌุจุฉ (ุฑ.ุณ) (ุซุงุจุชุฉ)</label>
            <input type="number" id="mealCost" value="28" disabled>
          </div>
        </div>
        <button id="addMealBtn" class="primary-btn">ุฅุถุงูุฉ ุงููุฌุจุฉ</button>

        <h3>ุงููุฌุจุงุช ุงููุณุฌูุฉ</h3>
        <div class="table-wrapper">
          <table id="mealsTable">
            <thead>
              <tr>
                <th>ุงูุชุงุฑูุฎ ุจุงููููุงุฏู</th>
                <th>ุนุฏุฏ ุงููุฌุจุงุช</th>
                <th>ุชูููุฉ ุงููุฌุจุฉ (ุฑ.ุณ)</th>
                <th>ุงููุฌููุน (ุนุฏุฏ ุงููุฌุจุงุช ร ุชูููุฉ ุงููุฌุจุฉ)</th>
                <th>ุชุนุฏูู</th>
                <th>ุญุฐู</th>
              </tr>
            </thead>
            <tbody>
              <!-- ูุชู ุงูุฅุถุงูุฉ ููุง -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 3- ุตูุญุฉ ุงูุฅุนุฏุงุฏ -->
    <section id="prepPage" class="page hidden">
      <h2>3- ุตูุญุฉ ุงูุฅุนุฏุงุฏ</h2>
      <button class="secondary-btn back-btn" onclick="showPage('mainPage')">โฌ ุฑุฌูุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ</button>

      <div class="card">
        <div class="form-row">
          <label>ุงูุชุงุฑูุฎ ุงููุณุฌูู ูู ุตูุญุฉ ุงููุฌุจุงุช (ุขุฎุฑ ุชุงุฑูุฎ ุชู ุฅุฏุฎุงูู):</label>
          <div class="value-box" id="prepDate">-</div>
        </div>

        <div class="form-row">
          <label>ุนุฏุฏ ุงููุฌุจุงุช ุงูุชู ุชู ุชุณุฌูููุง ูู ุตูุญุฉ ุงููุฌุจุงุช:</label>
          <div class="value-box" id="prepMealsCount">0</div>
        </div>
      </div>
    </section>

    <!-- 4- ุตูุญุฉ ุงูุญุณุงุจุงุช -->
    <section id="calcPage" class="page hidden">
      <h2>4- ุตูุญุฉ ุงูุญุณุงุจุงุช</h2>
      <button class="secondary-btn back-btn" onclick="showPage('mainPage')">โฌ ุฑุฌูุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ</button>

      <div class="card">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>ุงููุจูุบ ุงููุชููุฑ ุงููุณุฌูู ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ (ุฑ.ุณ)</th>
                <th>ูุฌููุน ุนุฏุฏ ุงููุฌุจุงุช</th>
                <th>ุงูุณุนุฑ ุงูุฅุฌูุงูู ูุนุฏุฏ ุชูููุฉ ุงููุฌุจุงุช (ุฑ.ุณ)</th>
                <th>ุงููุจูุบ ุงููุชุจูู ูู ุงููุจูุบ ุงูููุฑูุฑ (ุฑ.ุณ)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td id="calcAvailable">0.00</td>
                <td id="calcTotalMeals">0</td>
                <td id="calcTotalCost">0.00</td>
                <td id="calcRemaining">0.00</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 5- ููุฎุต ุงููุฌุจุงุช -->
    <section id="reportPage" class="page hidden">
      <h2>5- ููุฎุต ุงููุฌุจุงุช</h2>
      <button class="secondary-btn back-btn" onclick="showPage('mainPage')">โฌ ุฑุฌูุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ</button>

      <div class="card report">
        <p class="report-title">
          ุฅุนุงุดุฉ ุดูุฑ
          <span id="reportMonth">________</span>
          ูู
          <span id="reportFrom">________</span>
          ุฅูู
          <span id="reportTo">________</span>
          ุจูุฌุฑุงู
        </p>

        <div class="table-wrapper">
          <table id="reportTable">
            <thead>
              <tr>
                <th>ุงูุชุงุฑูุฎ ุจุงููููุงุฏู</th>
                <th>ุนุฏุฏ ุงููุฌุจุงุช</th>
                <th>ุชูููุฉ ุงููุฌุจุฉ (ุฑ.ุณ)</th>
                <th>ุงููุฌููุน (ูุชู ุถุฑุจ ุชูููุฉ ุงููุฌุจุฉ ูู ุนุฏุฏ ุงููุฌุจุงุช) (ุฑ.ุณ)</th>
              </tr>
            </thead>
            <tbody>
              <!-- ุงูุตููู ูู ุงูุฌุงูุงุณูุฑุจุช -->
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3">ุงููุฌููุน ุงูููู (ุจุนุฏ ุฌูุน ุงููุฌููุน ููู ูุฌุจุฉ) ุฑ.ุณ:</td>
                <td id="reportTotal">0.00</td>
              </tr>
              <tr>
                <td colspan="3">ุงููุฌููุน ุงูููู (ุณุนุฑ ุงููุฌููุน ูุชุงุจุฉ) ุฑ.ุณ:</td>
                <td id="reportTotalWords">ุตูุฑ ุฑูุงู</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <button class="primary-btn" onclick="window.print()">ุทุจุงุนุฉ ุงูููุฎุต (PDF)</button>
      </div>
    </section>

    <!-- 6- ุตูุญุฉ ุงูุฃุดูุฑ ุงููุญููุธุฉ -->
    <section id="monthsPage" class="page hidden">
      <h2>6- ุงูุฃุดูุฑ ุงููุญููุธุฉ</h2>
      <button class="secondary-btn back-btn" onclick="showPage('mainPage')">โฌ ุฑุฌูุน ููุตูุญุฉ ุงูุฑุฆูุณูุฉ</button>

      <div class="card months-card">
        <div class="table-wrapper">
          <table id="monthsTable">
            <thead>
              <tr>
                <th>ุงูุดูุฑ</th>
                <th>ุงููุชุฑุฉ</th>
                <th>ูุฌููุน ุนุฏุฏ ุงููุฌุจุงุช</th>
                <th>ุฅุฌูุงูู ุชูููุฉ ุงููุฌุจุงุช (ุฑ.ุณ)</th>
                <th>ุงููุจูุบ ุงููุชุจูู (ุฑ.ุณ)</th>
                <th>ุชุนุฏูู</th>
                <th>ุชูุงุตูู</th>
                <th>ุญุฐู</th>
              </tr>
            </thead>
            <tbody>
              <!-- ุชุนุจุฆุฉ ุชููุงุฆูุฉ -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ุตูุญุฉ ุชูุงุตูู ุงูุดูุฑ ุงููุญููุธ -->
    <section id="monthDetailsPage" class="page hidden">
      <h2>ุชูุงุตูู ุงูุดูุฑ ุงููุญููุธ</h2>
      <button class="secondary-btn back-btn" onclick="showPage('monthsPage')">โฌ ุฑุฌูุน ูุตูุญุฉ ุงูุฃุดูุฑ</button>

      <div class="card month-details-card">
        <p class="month-details-header">
          ุดูุฑ <span id="mdMonth">___</span>
          ูู <span id="mdFrom">___</span>
          ุฅูู <span id="mdTo">___</span>
        </p>
        <p class="month-details-meta">
          ุงููุจูุบ ุงููุชููุฑ: <span id="mdAmount">0.00</span> ุฑ.ุณ
          &nbsp;|&nbsp;
          ุงููุจูุบ ุงููุชุจูู: <span id="mdRemaining">0.00</span> ุฑ.ุณ
        </p>

        <div class="table-wrapper">
          <table id="monthDetailsTable">
            <thead>
              <tr>
                <th>ุงูุชุงุฑูุฎ ุจุงููููุงุฏู</th>
                <th>ุนุฏุฏ ุงููุฌุจุงุช</th>
                <th>ุชูููุฉ ุงููุฌุจุฉ (ุฑ.ุณ)</th>
                <th>ุงููุฌููุน (ุฑ.ุณ)</th>
              </tr>
            </thead>
            <tbody>
              <!-- ุชุนุจุฆุฉ ุชููุงุฆูุฉ -->
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3">ุงููุฌููุน ุงูููู ููุฐุง ุงูุดูุฑ (ุฑ.ุณ):</td>
                <td id="mdTotal">0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- ุงูุฌุงูุงุณูุฑุจุช ุฏุงุฎู ููุณ ุงูููู -->
  <script>
    const STORAGE_KEY = "amanatAidData";
    const MEAL_COST = 28; // ุชูููุฉ ุซุงุจุชุฉ ููู ูุฌุจุฉ

    let mainData = { month: "", amount: 0, from: "", to: "" };
    let meals = [];
    let savedMonths = [];

    function showPage(pageId) {
      const pages = document.querySelectorAll(".page");
      pages.forEach(p => p.classList.add("hidden"));
      document.getElementById(pageId).classList.remove("hidden");
    }

    function saveToStorage() {
      const data = { mainData, meals, savedMonths };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function computeRemainingForMonth(md, mealsArr) {
      const totalCost = (mealsArr || []).reduce((sum, m) => sum + (m.total || 0), 0);
      return (md.amount || 0) - totalCost;
    }

    // ุฅุฌูุงูู ุงููุจูุบ ุงููุชุจูู = ููุฒุงููุฉ ุฃูู ุดูุฑ ูุญููุธ - ูุฌููุน ูุตุงุฑูู ูู ุงูุฃุดูุฑ
    function updateGlobalRemaining() {
      const span = document.getElementById("globalRemaining");
      if (!span) return;

      if (!savedMonths.length) {
        span.textContent = "0.00";
        return;
      }

      const base = parseFloat(savedMonths[0].mainData?.amount) || 0;

      let totalSpent = 0;
      savedMonths.forEach(m => {
        (m.meals || []).forEach(meal => {
          const t = meal.total != null
            ? parseFloat(meal.total)
            : (parseFloat(meal.cost || 0) * parseFloat(meal.count || 0));
          totalSpent += isNaN(t) ? 0 : t;
        });
      });

      const remaining = base - totalSpent;
      span.textContent = remaining.toFixed(2);
    }

    function refreshSavedMonthsSelect() {
      const select = document.getElementById("savedMonthsSelect");
      select.innerHTML = "";
      if (!savedMonths.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "ูุง ุชูุฌุฏ ุฃุดูุฑ ูุญููุธุฉ ุจุนุฏ";
        select.appendChild(opt);
        updateGlobalRemaining();
        renderMonthsPage();
        return;
      }
      const first = document.createElement("option");
      first.value = "";
      first.textContent = "-- ุงุฎุชุฑ ุดูุฑ ูุญููุธ --";
      select.appendChild(first);

      savedMonths.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = m.label;
        select.appendChild(opt);
      });

      updateGlobalRemaining();
      renderMonthsPage();
    }

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        refreshSavedMonthsSelect();
        return;
      }
      try {
        const data = JSON.parse(raw);
        if (data.mainData) mainData = data.mainData;
        if (Array.isArray(data.meals)) meals = data.meals;
        if (Array.isArray(data.savedMonths)) savedMonths = data.savedMonths;
      } catch (e) {
        console.error(e);
      }

      document.getElementById("monthSelect").value = mainData.month || "";
      document.getElementById("availableAmount").value = mainData.amount || "";
      document.getElementById("dateFrom").value = mainData.from || "";
      document.getElementById("dateTo").value = mainData.to || "";

      renderMealsTable();
      updatePrepPage();
      updateCalculations();
      updateReportHeader();
      updateReportTable();
      refreshSavedMonthsSelect();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const saveMainBtn = document.getElementById("saveMainBtn");
      const addMealBtn = document.getElementById("addMealBtn");
      const saveMonthBtn = document.getElementById("saveMonthBtn");
      const loadMonthBtn = document.getElementById("loadMonthBtn");
      const updateMonthBtn = document.getElementById("updateMonthBtn");
      const deleteMonthBtn = document.getElementById("deleteMonthBtn");
      const savedMonthsSelect = document.getElementById("savedMonthsSelect");

      // ุญูุธ ุจูุงูุงุช ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
      saveMainBtn.addEventListener("click", () => {
        const month = document.getElementById("monthSelect").value;
        const amount = parseFloat(document.getElementById("availableAmount").value) || 0;
        const from = document.getElementById("dateFrom").value;
        const to = document.getElementById("dateTo").value;

        if (!month || !amount || !from || !to) {
          alert("ุงูุฑุฌุงุก ุชุนุจุฆุฉ ุฌููุน ุจูุงูุงุช ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ.");
          return;
        }

        mainData = { month, amount, from, to };
        updateCalculations();
        updatePrepPage();
        updateReportHeader();
        saveToStorage();
        alert("ุชู ุญูุธ ุจูุงูุงุช ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ุจูุฌุงุญ โ");
        showPage("mealsPage");
      });

      // ุฅุถุงูุฉ ูุฌุจุฉ
      addMealBtn.addEventListener("click", () => {
        const dateInput = document.getElementById("mealDate");
        const date = dateInput.value;
        const count = parseInt(document.getElementById("mealCount").value) || 0;

        if (!date) {
          alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุชุงุฑูุฎ ุฃูู ูุฑุฉุ ุซู ูู ุชุญุชุงุฌู ูุชุบููุฑู ุฅูุง ุนูุฏ ุชุบููุฑ ุงูููู.");
          return;
        }

        if (count <= 0) {
          alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุนุฏุฏ ุงููุฌุจุงุช ุจุดูู ุตุญูุญ.");
          return;
        }

        const cost = MEAL_COST;
        const total = count * cost;

        meals.push({ date, count, cost, total });

        document.getElementById("mealCount").value = "";

        renderMealsTable();
        updatePrepPage();
        updateCalculations();
        updateReportTable();
        saveToStorage();
      });

      // ุญูุธ ุงูุดูุฑ ูู ุงูุณุฌู + ุชูุฑูุบ ุงูุดุงุดุฉ
      saveMonthBtn.addEventListener("click", () => {
        if (!mainData.month) {
          alert("ุฃููุงู ุงุญูุธ ุจูุงูุงุช ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ูุญุฏุฏู ุงูุดูุฑ.");
          return;
        }

        const id = Date.now();
        const label = `${mainData.month} (${mainData.from || ""} - ${mainData.to || ""})`;
        const copyMeals = JSON.parse(JSON.stringify(meals));
        const remaining = computeRemainingForMonth(mainData, copyMeals);

        savedMonths.push({
          id,
          label,
          mainData: { ...mainData },
          meals: copyMeals,
          remaining
        });

        saveToStorage();
        refreshSavedMonthsSelect();
        alert("ุชู ุญูุธ ุจูุงูุงุช ูุฐุง ุงูุดูุฑ ูู ุงูุณุฌู โ\nุณูุชู ุงูุขู ุชุฌููุฒ ุงูุดุงุดุฉ ูุดูุฑ ุฌุฏูุฏ.");

        mainData = { month: "", amount: 0, from: "", to: "" };
        meals = [];

        document.getElementById("monthSelect").value = "";
        document.getElementById("availableAmount").value = "";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        document.getElementById("mealDate").value = "";
        document.getElementById("mealCount").value = "";

        renderMealsTable();
        updatePrepPage();
        updateCalculations();
        updateReportHeader();
        updateReportTable();
        saveToStorage();
        showPage("mainPage");
      });

      // ุงุณุชุฑุฌุงุน ุดูุฑ ูุญููุธ
      loadMonthBtn.addEventListener("click", () => {
        const id = savedMonthsSelect.value;
        if (!id) {
          alert("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุดูุฑ ูุญููุธ ุฃููุงู.");
          return;
        }
        const monthData = savedMonths.find(m => m.id.toString() === id);
        if (!monthData) {
          alert("ุชุนุฐุฑ ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ูุฐุง ุงูุดูุฑ.");
          return;
        }

        mainData = monthData.mainData || mainData;
        meals = monthData.meals || [];

        document.getElementById("monthSelect").value = mainData.month || "";
        document.getElementById("availableAmount").value = mainData.amount || "";
        document.getElementById("dateFrom").value = mainData.from || "";
        document.getElementById("dateTo").value = mainData.to || "";
        document.getElementById("mealDate").value = "";
        document.getElementById("mealCount").value = "";

        renderMealsTable();
        updatePrepPage();
        updateCalculations();
        updateReportHeader();
        updateReportTable();
        saveToStorage();
        alert("ุชู ุงุณุชุฑุฌุงุน ุจูุงูุงุช ุงูุดูุฑ ุงููุญุฏุฏ โ");
        showPage("mainPage");
      });

      // โ ุชุนุฏูู ุงูุดูุฑ ููุณู (ูู ุงูุดุฑูุท ุงูุนููู)
      updateMonthBtn.addEventListener("click", () => {
        const id = savedMonthsSelect.value;
        if (!id) {
          alert("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุดูุฑ ูุญููุธ ุฃููุงู ูุชุนุฏููู.");
          return;
        }
        const index = savedMonths.findIndex(m => m.id.toString() === id);
        if (index === -1) {
          alert("ุชุนุฐุฑ ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ูุฐุง ุงูุดูุฑ.");
          return;
        }

        if (!confirm("ุณูุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุดูุฑ ุงููุญุฏุฏ ุญุณุจ ูุง ูู ููุฌูุฏ ุงูุขู ูู ุงูุตูุญุงุชุ ูู ุฃูุช ูุชุฃูุฏุฉุ")) return;

        const label = `${mainData.month} (${mainData.from || ""} - ${mainData.to || ""})`;
        const copyMeals = JSON.parse(JSON.stringify(meals));
        const remaining = computeRemainingForMonth(mainData, copyMeals);

        savedMonths[index].label = label;
        savedMonths[index].mainData = { ...mainData };
        savedMonths[index].meals = copyMeals;
        savedMonths[index].remaining = remaining;

        saveToStorage();
        refreshSavedMonthsSelect();
        alert("ุชู ุชุนุฏูู ุจูุงูุงุช ุงูุดูุฑ ุงููุญุฏุฏ ุจูุฌุงุญ โ");
      });

      // ุญุฐู ุดูุฑ ูุญููุธ ูู ุงูุดุฑูุท ุงูุนููู
      deleteMonthBtn.addEventListener("click", () => {
        const id = savedMonthsSelect.value;
        if (!id) {
          alert("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุดูุฑ ูุญููุธ ุฃููุงู ูุญุฐูู.");
          return;
        }
        deleteSavedMonth(Number(id));
      });

      // ุชุญููู ุจูุงูุงุช ูุฏููุฉ
      loadFromStorage();
    });

    // ุฌุฏูู ุงููุฌุจุงุช ูุน ุฃุฒุฑุงุฑ ุชุนุฏูู/ุญุฐู
    function renderMealsTable() {
      const tbody = document.querySelector("#mealsTable tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      meals.forEach((meal, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${meal.date}</td>
          <td>${meal.count}</td>
          <td>${meal.cost.toFixed(2)}</td>
          <td>${meal.total.toFixed(2)}</td>
          <td><button class="edit-btn small-btn" onclick="editMeal(${index})">โ ุชุนุฏูู</button></td>
          <td><button class="delete-btn small-btn" onclick="deleteMeal(${index})">๐ ุญุฐู</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function editMeal(index) {
      const meal = meals[index];

      const newDate = prompt("ุชุนุฏูู ุงูุชุงุฑูุฎ:", meal.date);
      if (!newDate) return;

      const newCount = parseInt(prompt("ุชุนุฏูู ุนุฏุฏ ุงููุฌุจุงุช:", meal.count));
      if (isNaN(newCount) || newCount <= 0) {
        alert("ุนุฏุฏ ุงููุฌุจุงุช ุบูุฑ ุตุญูุญ");
        return;
      }

      meals[index].date = newDate;
      meals[index].count = newCount;
      meals[index].total = newCount * MEAL_COST;

      renderMealsTable();
      updatePrepPage();
      updateCalculations();
      updateReportTable();
      saveToStorage();

      alert("ุชู ุชุนุฏูู ุงููุฌุจุฉ ุจูุฌุงุญ โ");
    }

    function deleteMeal(index) {
      if (!confirm("ูู ุชุฑูุฏูู ุญุฐู ูุฐู ุงููุฌุจุฉุ")) return;
      meals.splice(index, 1);
      renderMealsTable();
      updatePrepPage();
      updateCalculations();
      updateReportTable();
      saveToStorage();
    }

    function updatePrepPage() {
      const prepDate = document.getElementById("prepDate");
      const prepMealsCount = document.getElementById("prepMealsCount");
      if (!prepDate || !prepMealsCount) return;

      if (!meals.length) {
        prepDate.textContent = "-";
        prepMealsCount.textContent = "0";
      } else {
        const lastMeal = meals[meals.length - 1];
        prepDate.textContent = lastMeal.date;
        prepMealsCount.textContent = meals.length.toString();
      }
    }

    function updateCalculations() {
      const calcAvailable = document.getElementById("calcAvailable");
      const calcTotalMeals = document.getElementById("calcTotalMeals");
      const calcTotalCost = document.getElementById("calcTotalCost");
      const calcRemaining = document.getElementById("calcRemaining");
      if (!calcAvailable) return;

      const totalMeals = meals.reduce((sum, m) => sum + m.count, 0);
      const totalCost = meals.reduce((sum, m) => sum + m.total, 0);

      calcAvailable.textContent = mainData.amount.toFixed(2);
      calcTotalMeals.textContent = totalMeals;
      calcTotalCost.textContent = totalCost.toFixed(2);
      const remaining = mainData.amount - totalCost;
      calcRemaining.textContent = remaining.toFixed(2);

      if (mainData.month) {
        savedMonths.forEach(m => {
          if (m.mainData &&
              m.mainData.month === mainData.month &&
              m.mainData.from === mainData.from &&
              m.mainData.to === mainData.to) {
            m.remaining = remaining;
          }
        });
        saveToStorage();
        updateGlobalRemaining();
      }
    }

    function updateReportHeader() {
      const m = document.getElementById("reportMonth");
      const f = document.getElementById("reportFrom");
      const t = document.getElementById("reportTo");
      if (!m) return;

      m.textContent = mainData.month || "________";
      f.textContent = mainData.from || "________";
      t.textContent = mainData.to || "________";
    }

    // ุชุญููู ุฑูู ุฅูู ูุชุงุจุฉ ุนุฑุจูุฉ ุจุณูุทุฉ (ุญุชู 999999)
    function numberToArabicWords(num) {
      num = Math.round(num);
      if (num === 0) return "ุตูุฑ ุฑูุงู";

      const ones = ["", "ูุงุญุฏ", "ุงุซูุงู", "ุซูุงุซุฉ", "ุฃุฑุจุนุฉ", "ุฎูุณุฉ", "ุณุชุฉ", "ุณุจุนุฉ", "ุซูุงููุฉ", "ุชุณุนุฉ"];
      const tens = ["", "ุนุดุฑุฉ", "ุนุดุฑูู", "ุซูุงุซูู", "ุฃุฑุจุนูู", "ุฎูุณูู", "ุณุชูู", "ุณุจุนูู", "ุซูุงููู", "ุชุณุนูู"];
      const teens = ["", "ุฃุญุฏ ุนุดุฑ", "ุงุซูุง ุนุดุฑ", "ุซูุงุซุฉ ุนุดุฑ", "ุฃุฑุจุนุฉ ุนุดุฑ", "ุฎูุณุฉ ุนุดุฑ", "ุณุชุฉ ุนุดุฑ", "ุณุจุนุฉ ุนุดุฑ", "ุซูุงููุฉ ุนุดุฑ", "ุชุณุนุฉ ุนุดุฑ"];
      const hundredsWords = ["", "ูุฆุฉ", "ูุฆุชุงู", "ุซูุงุซูุฆุฉ", "ุฃุฑุจุนูุฆุฉ", "ุฎูุณูุฆุฉ", "ุณุชูุฆุฉ", "ุณุจุนูุฆุฉ", "ุซูุงููุฆุฉ", "ุชุณุนูุฆุฉ"];

      function threeDigitsToWords(n) {
        let result = [];
        const hundreds = Math.floor(n / 100);
        const rest = n % 100;
        if (hundreds) result.push(hundredsWords[hundreds]);
        if (rest > 10 && rest < 20) {
          result.push(teens[rest - 10]);
        } else {
          const t = Math.floor(rest / 10);
          const o = rest % 10;
          if (o) result.push(ones[o]);
          if (t) result.push(tens[t]);
        }
        return result.join(" ู ");
      }

      let parts = [];
      const thousands = Math.floor(num / 1000);
      const remainder = num % 1000;

      if (thousands) {
        if (thousands === 1) {
          parts.push("ุฃูู");
        } else if (thousands === 2) {
          parts.push("ุฃููุงู");
        } else if (thousands >= 3 && thousands <= 10) {
          parts.push(threeDigitsToWords(thousands) + " ุขูุงู");
        } else {
          parts.push(threeDigitsToWords(thousands) + " ุฃูู");
        }
      }

      if (remainder) {
        const words = threeDigitsToWords(remainder);
        if (words) parts.push(words);
      }

      return parts.join(" ู ") + " ุฑูุงู";
    }

    function updateReportTable() {
      const tbody = document.querySelector("#reportTable tbody");
      const reportTotal = document.getElementById("reportTotal");
      const reportTotalWords = document.getElementById("reportTotalWords");
      if (!tbody || !reportTotal) return;

      tbody.innerHTML = "";
      let totalAll = 0;

      meals.forEach(meal => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${meal.date}</td>
          <td>${meal.count}</td>
          <td>${meal.cost.toFixed(2)}</td>
          <td>${meal.total.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
        totalAll += meal.total;
      });

      reportTotal.textContent = totalAll.toFixed(2);
      if (reportTotalWords) {
        reportTotalWords.textContent = numberToArabicWords(totalAll);
      }
    }

    // ุตูุญุฉ ุงูุฃุดูุฑ ุงููุญููุธุฉ
    function renderMonthsPage() {
      const tbody = document.querySelector("#monthsTable tbody");
      if (!tbody) return;
      tbody.innerHTML = "";

      if (!savedMonths.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="8" style="text-align:center;">ูุง ุชูุฌุฏ ุฃุดูุฑ ูุญููุธุฉ ุญุงููุงู</td>`;
        tbody.appendChild(tr);
        return;
      }

      savedMonths.forEach(m => {
        const md = m.mainData || {};
        const mealsArr = m.meals || [];
        const totalMeals = mealsArr.reduce((s, x) => s + (x.count || 0), 0);
        const totalCost = mealsArr.reduce((s, x) => {
          const t = x.total != null ? x.total : (x.cost || 0) * (x.count || 0);
          return s + t;
        }, 0);
        const remaining = (typeof m.remaining === "number")
          ? m.remaining
          : computeRemainingForMonth(md, mealsArr);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${md.month || ""}</td>
          <td>${(md.from || "")} - ${(md.to || "")}</td>
          <td>${totalMeals}</td>
          <td>${totalCost.toFixed(2)}</td>
          <td>${remaining.toFixed(2)}</td>
          <td><button class="edit-btn small-btn" onclick="editSavedMonth(${m.id})">โ ุชุนุฏูู</button></td>
          <td><button class="details-btn small-btn" onclick="viewMonthDetails(${m.id})">๐ ุชูุงุตูู</button></td>
          <td><button class="delete-btn small-btn" onclick="deleteSavedMonth(${m.id})">๐ ุญุฐู</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ุญุฐู ุดูุฑ ูุญููุธ (ุชูุณุชุฎุฏู ูู ุงูุฒุฑ ุงูุนููู ููู ุฌุฏูู ุงูุฃุดูุฑ)
    function deleteSavedMonth(id) {
      const index = savedMonths.findIndex(m => m.id === id);
      if (index === -1) {
        alert("ุชุนุฐุฑ ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ูุฐุง ุงูุดูุฑ.");
        return;
      }
      if (!confirm("ูู ุชุฑูุฏูู ุญุฐู ูุฐุง ุงูุดูุฑ ููุงุฆูุงูุ")) return;

      savedMonths.splice(index, 1);
      saveToStorage();
      refreshSavedMonthsSelect();
      alert("ุชู ุญุฐู ุงูุดูุฑ ุจูุฌุงุญ โ");
    }

    // ุชุนุฏูู ุดูุฑ ูู ุตู ุงูุฌุฏูู
    function editSavedMonth(id) {
      const monthData = savedMonths.find(m => m.id === id);
      if (!monthData) {
        alert("ุชุนุฐุฑ ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ูุฐุง ุงูุดูุฑ.");
        return;
      }

      mainData = monthData.mainData || mainData;
      meals = monthData.meals || [];

      document.getElementById("monthSelect").value = mainData.month || "";
      document.getElementById("availableAmount").value = mainData.amount || "";
      document.getElementById("dateFrom").value = mainData.from || "";
      document.getElementById("dateTo").value = mainData.to || "";
      document.getElementById("mealDate").value = "";
      document.getElementById("mealCount").value = "";

      renderMealsTable();
      updatePrepPage();
      updateCalculations();
      updateReportHeader();
      updateReportTable();
      saveToStorage();

      const select = document.getElementById("savedMonthsSelect");
      if (select) select.value = String(id);

      alert("ุชู ูุชุญ ุจูุงูุงุช ูุฐุง ุงูุดูุฑ ููุชุนุฏูู.\nุนุฏููู ุงูุจูุงูุงุช ุซู ุงุถุบุทู ุฒุฑ \"ุชุนุฏูู ุงูุดูุฑ ุงููุญุฏุฏ\" ูู ุงูุฃุนูู ูุญูุธ ุงูุชุบููุฑุงุช โ");
      showPage("mainPage");
    }

    // ุนุฑุถ ุชูุงุตูู ุดูุฑ ูู ุตูุญุฉ ุฎุงุตุฉ
    function viewMonthDetails(id) {
      const monthData = savedMonths.find(m => m.id === id);
      if (!monthData) {
        alert("ุชุนุฐุฑ ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ูุฐุง ุงูุดูุฑ.");
        return;
      }

      const md = monthData.mainData || {};
      const mealsArr = monthData.meals || [];
      const remaining = (typeof monthData.remaining === "number")
        ? monthData.remaining
        : computeRemainingForMonth(md, mealsArr);

      const spanMonth = document.getElementById("mdMonth");
      const spanFrom = document.getElementById("mdFrom");
      const spanTo = document.getElementById("mdTo");
      const spanAmount = document.getElementById("mdAmount");
      const spanRemaining = document.getElementById("mdRemaining");
      const tbody = document.querySelector("#monthDetailsTable tbody");
      const totalCell = document.getElementById("mdTotal");

      if (!tbody) return;

      spanMonth.textContent = md.month || "";
      spanFrom.textContent = md.from || "";
      spanTo.textContent = md.to || "";
      spanAmount.textContent = (md.amount || 0).toFixed(2);
      spanRemaining.textContent = remaining.toFixed(2);

      tbody.innerHTML = "";
      let totalAll = 0;

      mealsArr.forEach(meal => {
        const tr = document.createElement("tr");
        const cost = meal.cost != null ? meal.cost : MEAL_COST;
        const total = meal.total != null ? meal.total : cost * (meal.count || 0);
        tr.innerHTML = `
          <td>${meal.date}</td>
          <td>${meal.count}</td>
          <td>${cost.toFixed(2)}</td>
          <td>${total.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
        totalAll += total;
      });

      totalCell.textContent = totalAll.toFixed(2);

      showPage("monthDetailsPage");
    }
  </script>

  <!-- ุชุณุฌูู Service Worker ุนุดุงู ูุตูุฑ PWA -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => {
            console.log('Service Worker ูุณุฌู โ๏ธ', reg.scope);
          })
          .catch(err => {
            console.log('ูุดู ุชุณุฌูู Service Worker โ', err);
          });
      });
    }
  </script>

</body>
</html>
